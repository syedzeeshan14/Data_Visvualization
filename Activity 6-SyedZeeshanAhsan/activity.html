<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.js"></script>
    <link rel="stylesheet" href="styles.css">

</head>

<body>
    <div class="container">
        <div>
            <h1>CT Scan Images</h1>
        </div>
        <div class="slider">
            <label for="binCount">Bin Count</label>
            <input type="range" id="binCount" min="2" max="20" value="10" Step=1 />

            <label for="minThreshold">Min Threshold</label>
            <input type="range" id="minThreshold" min="0" max="100" value="0" />

            <label for="maxThreshold">Max Threshold</label>
            <input type="range" id="maxThreshold" min="0" max="1000" value="300" />

        </div>

        <hr />
        <div id="loading">
            <div class="spinner"></div>
            Loading...
        </div>
        <!-- Loading feedback -->
        <div class="main">
            <div id="files_container">
                <select id="files" name="file" size="10" multiple="multiple"></select>
            </div>
            <div class="canvas">
                <svg viewBox="-5 -10 270 270"></svg>
            </div>
        </div>
    </div>

    <script>
        const svg = d3.select("svg");
        const path = d3.geoPath();
        let currentBinCount = +document.querySelector("#binCount").value;
        let currentMin = +document.querySelector("#minThreshold").value;
        let currentMax = +document.querySelector("#maxThreshold").value;

        let minValue, maxValue; // Declare variables for min and max values
        function plot_contour(fileNumber) {

            // Step 1 read csv file
            d3.json("dicomData/" + fileNumber).then(data =>

                {
                    // show loading while we work
                    d3.select("#loading").style("display", "block");
                    d3.select("svg").selectAll("*").remove()
                        // data dimensions
                    let m = 256,
                        n = 256;
                    // Step 2 convert data into 1D list
                    let values_density = []
                    data.forEach(col => {
                        col.forEach(d => values_density.push(+d))
                    })

                    const min_max = d3.extent(values_density, d => d)
                        // Set initial min and max values
                    minValue = min_max[0];
                    maxValue = min_max[1];

                    // configure sliders to data domain
                    const minSlider = document.querySelector("#minThreshold");
                    const maxSlider = document.querySelector("#maxThreshold");
                    const binSlider = document.querySelector("#binCount");

                    minSlider.min = minValue;
                    minSlider.max = maxValue;
                    maxSlider.min = minValue;
                    maxSlider.max = maxValue;

                    // reset current values if out of bounds or invalid
                    if (!Number.isFinite(currentMin) || currentMin < minValue || currentMin >= maxValue) {
                        currentMin = minValue;
                        minSlider.value = currentMin;
                    }
                    if (!Number.isFinite(currentMax) || currentMax > maxValue || currentMax <= minValue) {
                        currentMax = maxValue;
                        maxSlider.value = currentMax;
                    }
                    // ensure reasonable bin count
                    currentBinCount = Math.max(2, Math.min(20, +binSlider.value || 10));
                    binSlider.value = currentBinCount;

                    /////////////////COLOR + CONTOUR/////////////////////////////
                    function draw(binCount, minThreshold, maxThreshold) {
                        svg.selectAll(".contours").remove();

                        const lo = Math.max(minValue, +minThreshold);
                        const hi = Math.min(maxValue, +maxThreshold);
                        const valid = hi > lo;
                        const bins = Math.max(2, Math.floor(+binCount));

                        // color scale: 7 stops across [lo, hi]
                        const stops = d3.range(7).map(i => lo + (i * (hi - lo)) / 6);
                        const colorScale = d3.scaleLinear()
                            .domain(stops)
                            .range(["#0d1a50", "#3e5eba", "#2b83ba", "#abdda4", "#ffffbf", "#fdae61", "#d7191c"])
                            .interpolate(d3.interpolateHcl);

                        // thresholds based on bin count and selected window
                        const step = (hi - lo) / bins;
                        const thresholds = valid ? d3.range(lo, hi, step) : [lo];

                        const contours = d3.contours()
                            .size([m, n])
                            .thresholds(thresholds)
                            (values_density);

                        svg.append("g")
                            .attr("class", "contours")
                            .selectAll("path")
                            .data(contours)
                            .enter()
                            .append("path")
                            .attr("d", d => path(d))
                            .attr("stroke", "black")
                            .attr("stroke-width", ".1px")
                            .attr("stroke-linejoin", "round")
                            .attr("fill", d => colorScale(d.value));

                        // hide loading once drawn
                        d3.select("#loading").style("display", "none");
                    }

                    // initial draw for this file
                    draw(currentBinCount, currentMin, currentMax);

                    // expose current draw to global handler so inputs redraw latest dataset
                    window._drawContours = () => draw(currentBinCount, currentMin, currentMax);

                    if (!window._inputsWired) {
                        document.addEventListener("input", e => {
                            if (e.target && (e.target.id === "binCount" || e.target.id === "minThreshold" || e.target.id === "maxThreshold")) {
                                currentBinCount = +document.querySelector("#binCount").value;
                                currentMin = +document.querySelector("#minThreshold").value;
                                currentMax = +document.querySelector("#maxThreshold").value;
                                if (typeof window._drawContours === "function") {
                                    window._drawContours();
                                }
                            }
                        });
                        window._inputsWired = true;
                    }




                })
        }
        filesList()


        plot_contour("brain_001.dcm.json")

        function filesList() {

            const files_data = ["brain_001.dcm.json", "brain_002.dcm.json",
                "brain_003.dcm.json", "brain_004.dcm.json",
                "brain_005.dcm.json", "brain_006.dcm.json",
                "brain_007.dcm.json", "brain_008.dcm.json",
                "brain_009.dcm.json", "brain_010.dcm.json",
                "brain_011.dcm.json", "brain_012.dcm.json",
                "brain_013.dcm.json", "brain_014.dcm.json",
                "brain_015.dcm.json", "brain_016.dcm.json",
                "brain_017.dcm.json", "brain_018.dcm.json", "brain_019.dcm.json", "brain_020.dcm.json"
            ]
            const selectElement = d3.select("#files");
            const options = selectElement
                .selectAll("option")
                .data(files_data)
                .enter()
                .append("option")
                .text(d => d)

            selectElement.on("change", (d) => {
                const selectedOption = selectElement.property("value");
                plot_contour(selectedOption)
            });

            selectElement.attr("size", files_data.length);

        }
    </script>
</body>

</html>